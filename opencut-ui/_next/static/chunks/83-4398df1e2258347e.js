"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[83],{8300:(e,t,a)=>{a.d(t,{A:()=>p});var i=a(59467),r=a(14700),n=a(75141),o=a(80196),d=a(19439),s=a(82337),l=a(93146),c=a(87100);let m=e=>{let t=[...e].sort((e,t)=>e.startTime-t.startTime);for(let e=0;e<t.length-1;e++){let a=t[e],i=t[e+1];if(a.startTime+(a.duration-a.trimStart-a.trimEnd)>i.startTime)return!0}return!1},u=e=>{let t=[...e].sort((e,t)=>e.startTime-t.startTime),a=[];for(let e=0;e<t.length;e++){let i={...t[e]};if(a.length>0){let e=a[a.length-1],t=e.startTime+(e.duration-e.trimStart-e.trimEnd);i.startTime<t&&(i.startTime=t)}a.push(i)}return a},h=(e,t)=>{let a=e.replace(/ \(left\)$/,"").replace(/ \(right\)$/,"").replace(/ \(audio\)$/,"").replace(/ \(split \d+\)$/,"");return"".concat(a," (").concat(t,")")},p=(0,i.v)((e,t)=>{let i=t=>{let a=(0,r.zb)(t),i=(0,r.Oy)(a);e({_tracks:a,tracks:i})},p=async()=>{let e=s.I.getState().activeProject;if(e)try{await d.P.saveTimeline(e.id,t()._tracks)}catch(e){}},f=e=>{i(e),setTimeout(p,100)},g=(0,r.zb)([]),y=(0,r.Oy)(g);return{_tracks:g,tracks:y,history:[],redoStack:[],selectedElements:[],rippleEditingEnabled:!1,snappingEnabled:!0,getSortedTracks:()=>{let{_tracks:e}=t(),a=(0,r.zb)(e);return(0,r.Oy)(a)},pushHistory:()=>{let{_tracks:a,history:i}=t();e({history:[...i,JSON.parse(JSON.stringify(a))],redoStack:[]})},undo:()=>{let{history:a,redoStack:i,_tracks:r}=t();0!==a.length&&(f(a[a.length-1]),e({history:a.slice(0,-1),redoStack:[...i,JSON.parse(JSON.stringify(r))]}))},selectElement:function(t,a){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e(e=>{let r=e.selectedElements.some(e=>e.trackId===t&&e.elementId===a);return i?r?{selectedElements:e.selectedElements.filter(e=>e.trackId!==t||e.elementId!==a)}:{selectedElements:[...e.selectedElements,{trackId:t,elementId:a}]}:{selectedElements:[{trackId:t,elementId:a}]}})},deselectElement:(t,a)=>{e(e=>({selectedElements:e.selectedElements.filter(e=>e.trackId!==t||e.elementId!==a)}))},clearSelectedElements:()=>{e({selectedElements:[]})},setSelectedElements:t=>e({selectedElements:t}),addTrack:e=>{t().pushHistory();let a={id:(0,l.lk)(),name:"media"===e?"Media Track":"text"===e?"Text Track":"audio"===e?"Audio Track":"Track",type:e,elements:[],muted:!1};return f([...t()._tracks,a]),a.id},insertTrackAt:(e,a)=>{t().pushHistory();let i={id:(0,l.lk)(),name:"media"===e?"Media Track":"text"===e?"Text Track":"audio"===e?"Audio Track":"Track",type:e,elements:[],muted:!1},r=[...t()._tracks];return r.splice(a,0,i),f(r),i.id},removeTrack:e=>{let{rippleEditingEnabled:a}=t();a?t().removeTrackWithRipple(e):(t().pushHistory(),f(t()._tracks.filter(t=>t.id!==e)))},removeTrackWithRipple:e=>{let{_tracks:a}=t(),i=a.find(t=>t.id===e);if(!i)return;if(t().pushHistory(),0===i.elements.length)return void f(a.filter(t=>t.id!==e));let r=i.elements.map(e=>({startTime:e.startTime,endTime:e.startTime+(e.duration-e.trimStart-e.trimEnd)}));r.sort((e,t)=>e.startTime-t.startTime);let n=[];for(let e of r)if(0===n.length)n.push({startTime:e.startTime,endTime:e.endTime,duration:e.endTime-e.startTime});else{let t=n[n.length-1];e.startTime<=t.endTime?(t.endTime=Math.max(t.endTime,e.endTime),t.duration=t.endTime-t.startTime):n.push({startTime:e.startTime,endTime:e.endTime,duration:e.endTime-e.startTime})}f(a.filter(t=>t.id!==e).map(e=>{let t=e.elements.map(e=>{let t=e.startTime;for(let e=n.length-1;e>=0;e--){let a=n[e];t>=a.endTime&&(t-=a.duration)}return{...e,startTime:Math.max(0,t)}});if(m(t)){let a=u(t);return{...e,elements:a}}return{...e,elements:t}}))},addElementToTrack:(e,a)=>{t().pushHistory();let i=t()._tracks.find(t=>t.id===e);if(!i||!(0,r.aI)(a,i).isValid||"media"===a.type&&!a.mediaId||"text"===a.type&&!a.content)return;let d=t()._tracks.reduce((e,t)=>e+t.elements.length,0),c={...a,id:(0,l.lk)(),startTime:a.startTime||0,trimStart:0,trimEnd:0};if(0===d&&"media"===c.type){let e=o.B.getState().mediaItems.find(e=>e.id===c.mediaId);if(e&&("image"===e.type||"video"===e.type)&&n.U.getState().setCanvasSizeFromAspectRatio((0,o.C)(e)),e&&"video"===e.type&&e.fps){let t=s.I.getState();t.activeProject&&t.updateProjectFps(e.fps)}}f(t()._tracks.map(t=>t.id===e?{...t,elements:[...t.elements,c]}:t)),t().selectElement(e,c.id)},removeElementFromTrack:function(e,a){let i=!(arguments.length>2)||void 0===arguments[2]||arguments[2],{rippleEditingEnabled:r}=t();r?t().removeElementFromTrackWithRipple(e,a,i):(i&&t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.filter(e=>e.id!==a)}:t).filter(e=>e.elements.length>0)))},removeElementFromTrackWithRipple:function(e,a){let i=!(arguments.length>2)||void 0===arguments[2]||arguments[2],{_tracks:r,rippleEditingEnabled:n}=t();if(!n)return void t().removeElementFromTrack(e,a,i);let o=r.find(t=>t.id===e),d=null==o?void 0:o.elements.find(e=>e.id===a);if(!d||!o)return;i&&t().pushHistory();let s=d.startTime,l=d.duration-d.trimStart-d.trimEnd,c=s+l;f(r.map(t=>{let i=t.id===e,r=t.elements.filter(i=>i.id!==a||t.id!==e).map(e=>i&&e.startTime>=c?{...e,startTime:Math.max(0,e.startTime-l)}:e);if(m(r)){let e=u(r);return{...t,elements:e}}return{...t,elements:r}}).filter(e=>e.elements.length>0||e.isMain))},moveElementToTrack:(e,a,i)=>{t().pushHistory();let n=t()._tracks.find(t=>t.id===e),o=t()._tracks.find(e=>e.id===a),d=null==n?void 0:n.elements.find(e=>e.id===i);d&&o&&(0,r.aI)(d,o).isValid&&f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.filter(e=>e.id!==i)}:t.id===a?{...t,elements:[...t.elements,d]}:t).filter(e=>e.elements.length>0))},updateElementTrim:function(e,a,i,r){let n=!(arguments.length>4)||void 0===arguments[4]||arguments[4];n&&t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,trimStart:i,trimEnd:r}:e)}:t))},updateElementDuration:function(e,a,i){let r=!(arguments.length>3)||void 0===arguments[3]||arguments[3];r&&t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,duration:i}:e)}:t))},updateElementStartTime:function(e,a,i){let r=!(arguments.length>3)||void 0===arguments[3]||arguments[3];r&&t().pushHistory();let n=Math.max(0,i);f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,startTime:n}:e)}:t))},updateElementStartTimeWithRipple:(e,a,i)=>{let{_tracks:r,rippleEditingEnabled:n}=t();if(!n)return void t().updateElementStartTime(e,a,i);let o=r.find(t=>t.id===e),d=null==o?void 0:o.elements.find(e=>e.id===a);if(!d||!o)return;t().pushHistory();let s=d.startTime,l=d.startTime+(d.duration-d.trimStart-d.trimEnd),c=i+(d.duration-d.trimStart-d.trimEnd),h=i-s;f(r.map(t=>{let r=t.id===e,n=t.elements.map(n=>{if(n.id===a&&t.id===e)return{...n,startTime:Math.max(0,i)};if(!r)return n;let o=n.startTime;if(n.startTime,n.duration,n.trimStart,n.trimEnd,h>0){if(o>=l)return{...n,startTime:o+h}}else if(h<0&&o>=c&&o>=s)return{...n,startTime:Math.max(0,o+h)};return n});if(m(n)){let e=u(n);return{...t,elements:e}}return{...t,elements:n}}))},toggleTrackMute:e=>{t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,muted:!t.muted}:t))},toggleElementHidden:(e,a)=>{t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,hidden:!e.hidden}:e)}:t))},updateTextElement:(e,a,i)=>{t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a&&"text"===e.type?{...e,...i}:e)}:t))},splitElement:(e,a,i)=>{let{_tracks:r}=t(),n=r.find(t=>t.id===e),o=null==n?void 0:n.elements.find(e=>e.id===a);if(!o)return null;let d=o.startTime,s=o.startTime+(o.duration-o.trimStart-o.trimEnd);if(i<=d||i>=s)return null;t().pushHistory();let c=i-o.startTime,m=o.duration-o.trimStart-o.trimEnd-c,u=(0,l.lk)();return f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.flatMap(e=>e.id===a?[{...e,trimEnd:e.trimEnd+m,name:h(e.name,"left")},{...e,id:u,startTime:i,trimStart:e.trimStart+c,name:h(e.name,"right")}]:[e])}:t)),u},splitAndKeepLeft:(e,a,i)=>{let{_tracks:r}=t(),n=r.find(t=>t.id===e),o=null==n?void 0:n.elements.find(e=>e.id===a);if(!o)return;let d=o.startTime,s=o.startTime+(o.duration-o.trimStart-o.trimEnd);if(i<=d||i>=s)return;t().pushHistory();let l=i-o.startTime,c=o.duration-o.trimStart-o.trimEnd-l;f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,trimEnd:e.trimEnd+c,name:h(e.name,"left")}:e)}:t))},splitAndKeepRight:(e,a,i)=>{let{_tracks:r}=t(),n=r.find(t=>t.id===e),o=null==n?void 0:n.elements.find(e=>e.id===a);if(!o)return;let d=o.startTime,s=o.startTime+(o.duration-o.trimStart-o.trimEnd);if(i<=d||i>=s)return;t().pushHistory();let l=i-o.startTime;f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,startTime:i,trimStart:e.trimStart+l,name:h(e.name,"right")}:e)}:t))},separateAudio:(e,a)=>{let{_tracks:i}=t(),r=i.find(t=>t.id===e),n=null==r?void 0:r.elements.find(e=>e.id===a);if(!n||(null==r?void 0:r.type)!=="media")return null;t().pushHistory();let o=i.find(e=>"audio"===e.type),d=(0,l.lk)();if(o)f(t()._tracks.map(e=>e.id===o.id?{...e,elements:[...e.elements,{...n,id:d,name:h(n.name,"audio")}]}:e));else{let e={id:(0,l.lk)(),name:"Audio Track",type:"audio",elements:[{...n,id:d,name:h(n.name,"audio")}],muted:!1};f([...t()._tracks,e])}return d},replaceElementMedia:async(e,i,r)=>{let{_tracks:n}=t(),d=n.find(t=>t.id===e),l=null==d?void 0:d.elements.find(e=>e.id===i);if(!l)return{success:!1,error:"Timeline element not found"};if("media"!==l.type)return{success:!1,error:"Replace is only available for media clips"};try{let d=o.B.getState(),l=s.I.getState();if(!l.activeProject)return{success:!1,error:"No active project found"};let{getFileType:c,getImageDimensions:m,generateVideoThumbnail:u,getMediaDuration:h}=await Promise.resolve().then(a.bind(a,80196)),p=c(r);if(!p)return{success:!1,error:"Unsupported file type. Please select a video, audio, or image file."};let g={name:r.name,type:p,file:r,url:URL.createObjectURL(r)};try{if("image"===p){let{width:e,height:t}=await m(r);g.width=e,g.height=t}else if("video"===p){let[e,{thumbnailUrl:t,width:a,height:i}]=await Promise.all([h(r),u(r)]);g.duration=e,g.thumbnailUrl=t,g.width=a,g.height=i}else"audio"===p&&(g.duration=await h(r))}catch(e){return{success:!1,error:"Failed to process ".concat(p," file: ").concat(e instanceof Error?e.message:"Unknown error")}}try{await d.addMediaItem(l.activeProject.id,g)}catch(e){return{success:!1,error:"Failed to add media to project: ".concat(e instanceof Error?e.message:"Unknown error")}}let y=d.mediaItems.find(e=>e.file===r);if(!y)return{success:!1,error:"Failed to create media item in project. Please try again."};return t().pushHistory(),f(n.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===i?{...e,mediaId:y.id,name:y.name,duration:y.duration||e.duration}:e)}:t)),{success:!0}}catch(e){return{success:!1,error:"Unexpected error: ".concat(e instanceof Error?e.message:"Unknown error")}}},getTotalDuration:()=>{let{_tracks:e}=t();return 0===e.length?0:Math.max(...e.map(e=>e.elements.reduce((e,t)=>Math.max(e,t.startTime+t.duration-t.trimStart-t.trimEnd),0)),0)},getProjectThumbnail:async e=>{try{let t=await d.P.loadTimeline(e),i=await d.P.loadAllMediaItems(e);if(!t||!i.length)return null;let r=t.flatMap(e=>e.elements).filter(e=>"media"===e.type).sort((e,t)=>e.startTime-t.startTime)[0];if(!r)return null;let n=i.find(e=>e.id===r.mediaId);if(!n)return null;if("video"===n.type&&n.file){let{generateVideoThumbnail:e}=await Promise.resolve().then(a.bind(a,80196)),{thumbnailUrl:t}=await e(n.file);return t}if("image"===n.type&&n.url)return n.url;return null}catch(e){return null}},redo:()=>{let{redoStack:a}=t();0!==a.length&&(f(a[a.length-1]),e({redoStack:a.slice(0,-1)}))},dragState:{isDragging:!1,elementId:null,trackId:null,startMouseX:0,startElementTime:0,clickOffsetTime:0,currentTime:0},setDragState:t=>e(e=>({dragState:{...e.dragState,...t}})),startDrag:(t,a,i,r,n)=>{e({dragState:{isDragging:!0,elementId:t,trackId:a,startMouseX:i,startElementTime:r,clickOffsetTime:n,currentTime:r}})},updateDragTime:t=>{e(e=>({dragState:{...e.dragState,currentTime:t}}))},endDrag:()=>{e({dragState:{isDragging:!1,elementId:null,trackId:null,startMouseX:0,startElementTime:0,clickOffsetTime:0,currentTime:0}})},loadProjectTimeline:async t=>{try{let a=await d.P.loadTimeline(t);if(a)i(a);else{let e=(0,r.zb)([]);i(e)}e({history:[],redoStack:[]})}catch(t){i((0,r.zb)([])),e({history:[],redoStack:[]})}},saveProjectTimeline:async e=>{try{await d.P.saveTimeline(e,t()._tracks)}catch(e){}},clearTimeline:()=>{i((0,r.zb)([])),e({history:[],redoStack:[],selectedElements:[]})},toggleSnapping:()=>{e(e=>({snappingEnabled:!e.snappingEnabled}))},toggleRippleEditing:()=>{e(e=>({rippleEditingEnabled:!e.rippleEditingEnabled}))},checkElementOverlap:(e,a,i,r)=>{let n=t()._tracks.find(t=>t.id===e);return!!n&&n.elements.some(e=>{let t=e.startTime+e.duration-e.trimStart-e.trimEnd;return e.id!==r&&(a>=e.startTime&&a<t||a+i>e.startTime&&a+i<=t||a<e.startTime&&a+i>t)})},findOrCreateTrack:e=>{if("text"===e)return t().insertTrackAt(e,0);let a=t()._tracks.find(t=>t.type===e);return a?a.id:t().addTrack(e)},addMediaAtTime:function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i="audio"===e.type?"audio":"media",r=e.duration||c.of.DEFAULT_IMAGE_DURATION,n=t()._tracks.filter(e=>e.type===i),o=null;for(let e of n)if(!t().checkElementOverlap(e.id,a,r)){o=e.id;break}return o||(o=t().addTrack(i)),t().addElementToTrack(o,{type:"media",mediaId:e.id,name:e.name,duration:r,startTime:a,trimStart:0,trimEnd:0}),!0},addTextAtTime:function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=t().insertTrackAt("text",0);return t().addElementToTrack(i,{type:"text",name:e.name||"Text",content:e.content||"Default Text",duration:e.duration||c.of.DEFAULT_TEXT_DURATION,startTime:a,trimStart:0,trimEnd:0,fontSize:e.fontSize||48,fontFamily:e.fontFamily||"Arial",color:e.color||"#ffffff",backgroundColor:e.backgroundColor||"transparent",textAlign:e.textAlign||"center",fontWeight:e.fontWeight||"normal",fontStyle:e.fontStyle||"normal",textDecoration:e.textDecoration||"none",x:e.x||0,y:e.y||0,rotation:e.rotation||0,opacity:void 0!==e.opacity?e.opacity:1}),!0},addMediaToNewTrack:e=>{let a="audio"===e.type?"audio":"media",i=t().findOrCreateTrack(a);return t().addElementToTrack(i,{type:"media",mediaId:e.id,name:e.name,duration:e.duration||c.of.DEFAULT_IMAGE_DURATION,startTime:0,trimStart:0,trimEnd:0}),!0},addTextToNewTrack:e=>{let a=t().insertTrackAt("text",0);return t().addElementToTrack(a,{type:"text",name:e.name||"Text",content:("content"in e?e.content:"Default Text")||"Default Text",duration:c.of.DEFAULT_TEXT_DURATION,startTime:0,trimStart:0,trimEnd:0,fontSize:("fontSize"in e?e.fontSize:48)||48,fontFamily:("fontFamily"in e?e.fontFamily:"Arial")||"Arial",color:("color"in e?e.color:"#ffffff")||"#ffffff",backgroundColor:("backgroundColor"in e?e.backgroundColor:"transparent")||"transparent",textAlign:("textAlign"in e?e.textAlign:"center")||"center",fontWeight:("fontWeight"in e?e.fontWeight:"normal")||"normal",fontStyle:("fontStyle"in e?e.fontStyle:"normal")||"normal",textDecoration:("textDecoration"in e?e.textDecoration:"none")||"none",x:("x"in e?e.x:0)||0,y:("y"in e?e.y:0)||0,rotation:("rotation"in e?e.rotation:0)||0,opacity:"opacity"in e&&void 0!==e.opacity?e.opacity:1}),!0}}})},14700:(e,t,a)=>{a.d(t,{Oy:()=>r,aI:()=>s,hX:()=>d,xK:()=>n,zb:()=>o});var i=a(93146);function r(e){return[...e].sort((e,t)=>"text"===e.type&&"text"!==t.type?-1:"text"===t.type&&"text"!==e.type||"audio"===e.type&&"audio"!==t.type?1:"audio"===t.type&&"audio"!==e.type?-1:e.isMain&&!t.isMain&&"audio"!==t.type&&"text"!==t.type?1:t.isMain&&!e.isMain&&"audio"!==e.type&&"text"!==e.type?-1:0)}function n(e){return e.find(e=>e.isMain)||null}function o(e){return e.some(e=>e.isMain)?e:[{id:(0,i.lk)(),name:"Main Track",type:"media",elements:[],muted:!1,isMain:!0},...e]}function d(e,t){return"text"===e?"text"===t:"media"===e&&("media"===t||"audio"===t)}function s(e,t){return d(e.type,t.type)?{isValid:!0}:{isValid:!1,errorMessage:"text"===e.type?"Text elements can only be placed on text tracks":"Media elements can only be placed on media or audio tracks"}}},19439:(e,t,a)=>{a.d(t,{P:()=>o});class i{async getDB(){return new Promise((e,t)=>{let a=indexedDB.open(this.dbName,this.version);a.onerror=()=>t(a.error),a.onsuccess=()=>e(a.result),a.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName,{keyPath:"id"})}})}async get(e){let t=(await this.getDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((a,i)=>{let r=t.get(e);r.onerror=()=>i(r.error),r.onsuccess=()=>a(r.result||null)})}async set(e,t){let a=(await this.getDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise((i,r)=>{let n=a.put({id:e,...t});n.onerror=()=>r(n.error),n.onsuccess=()=>i()})}async remove(e){let t=(await this.getDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise((a,i)=>{let r=t.delete(e);r.onerror=()=>i(r.error),r.onsuccess=()=>a()})}async list(){let e=(await this.getDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((t,a)=>{let i=e.getAllKeys();i.onerror=()=>a(i.error),i.onsuccess=()=>t(i.result)})}async clear(){let e=(await this.getDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise((t,a)=>{let i=e.clear();i.onerror=()=>a(i.error),i.onsuccess=()=>t()})}constructor(e,t,a=1){this.dbName=e,this.storeName=t,this.version=a}}class r{async getDirectory(){let e=await navigator.storage.getDirectory();return await e.getDirectoryHandle(this.directoryName,{create:!0})}async get(e){try{let t=await this.getDirectory(),a=await t.getFileHandle(e);return await a.getFile()}catch(e){if("NotFoundError"===e.name)return null;throw e}}async set(e,t){let a=await this.getDirectory(),i=await a.getFileHandle(e,{create:!0}),r=await i.createWritable();await r.write(t),await r.close()}async remove(e){try{let t=await this.getDirectory();await t.removeEntry(e)}catch(e){if("NotFoundError"!==e.name)throw e}}async list(){let e=await this.getDirectory(),t=[];for await(let a of e.keys())t.push(a);return t}async clear(){let e=await this.getDirectory();for await(let t of e.keys())await e.removeEntry(t)}static isSupported(){return"storage"in navigator&&"getDirectory"in navigator.storage}constructor(e="media"){this.directoryName=e}}class n{getProjectMediaAdapters(e){return{mediaMetadataAdapter:new i("".concat(this.config.mediaDb,"-").concat(e),"media-metadata",this.config.version),mediaFilesAdapter:new r("media-files-".concat(e))}}getProjectTimelineAdapter(e){return new i("".concat(this.config.timelineDb,"-").concat(e),"timeline",this.config.version)}async saveProject(e){let t={id:e.id,name:e.name,thumbnail:e.thumbnail,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString(),backgroundColor:e.backgroundColor,backgroundType:e.backgroundType,blurIntensity:e.blurIntensity,bookmarks:e.bookmarks,fps:e.fps};await this.projectsAdapter.set(e.id,t)}async loadProject(e){let t=await this.projectsAdapter.get(e);return t?{id:t.id,name:t.name,thumbnail:t.thumbnail,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),backgroundColor:t.backgroundColor,backgroundType:t.backgroundType,blurIntensity:t.blurIntensity,bookmarks:t.bookmarks,fps:t.fps}:null}async loadAllProjects(){let e=await this.projectsAdapter.list(),t=[];for(let a of e){let e=await this.loadProject(a);e&&t.push(e)}return t.sort((e,t)=>t.updatedAt.getTime()-e.updatedAt.getTime())}async deleteProject(e){await this.projectsAdapter.remove(e)}async saveMediaItem(e,t){let{mediaMetadataAdapter:a,mediaFilesAdapter:i}=this.getProjectMediaAdapters(e);await i.set(t.id,t.file);let r={id:t.id,name:t.name,type:t.type,size:t.file.size,lastModified:t.file.lastModified,width:t.width,height:t.height,duration:t.duration};await a.set(t.id,r)}async loadMediaItem(e,t){let{mediaMetadataAdapter:a,mediaFilesAdapter:i}=this.getProjectMediaAdapters(e),[r,n]=await Promise.all([i.get(t),a.get(t)]);if(!r||!n)return null;let o=URL.createObjectURL(r);return{id:n.id,name:n.name,type:n.type,file:r,url:o,width:n.width,height:n.height,duration:n.duration}}async loadAllMediaItems(e){let{mediaMetadataAdapter:t}=this.getProjectMediaAdapters(e),a=await t.list(),i=[];for(let t of a){let a=await this.loadMediaItem(e,t);a&&i.push(a)}return i}async deleteMediaItem(e,t){let{mediaMetadataAdapter:a,mediaFilesAdapter:i}=this.getProjectMediaAdapters(e);await Promise.all([i.remove(t),a.remove(t)])}async deleteProjectMedia(e){let{mediaMetadataAdapter:t,mediaFilesAdapter:a}=this.getProjectMediaAdapters(e);await Promise.all([t.clear(),a.clear()])}async saveTimeline(e,t){let a=this.getProjectTimelineAdapter(e),i={tracks:t,lastModified:new Date().toISOString()};await a.set("timeline",i)}async loadTimeline(e){let t=this.getProjectTimelineAdapter(e),a=await t.get("timeline");return a?a.tracks:null}async deleteProjectTimeline(e){let t=this.getProjectTimelineAdapter(e);await t.remove("timeline")}async clearAllData(){await this.projectsAdapter.clear()}async getStorageInfo(){return{projects:(await this.projectsAdapter.list()).length,isOPFSSupported:this.isOPFSSupported(),isIndexedDBSupported:this.isIndexedDBSupported()}}async getProjectStorageInfo(e){let{mediaMetadataAdapter:t}=this.getProjectMediaAdapters(e),a=this.getProjectTimelineAdapter(e),[i,r]=await Promise.all([t.list(),a.get("timeline")]);return{mediaItems:i.length,hasTimeline:!!r}}async loadSavedSounds(){try{return await this.savedSoundsAdapter.get("user-sounds")||{sounds:[],lastModified:new Date().toISOString()}}catch(e){return{sounds:[],lastModified:new Date().toISOString()}}}async saveSoundEffect(e){try{let t=await this.loadSavedSounds();if(t.sounds.some(t=>t.id===e.id))return;let a={id:e.id,name:e.name,username:e.username,previewUrl:e.previewUrl,downloadUrl:e.downloadUrl,duration:e.duration,tags:e.tags,license:e.license,savedAt:new Date().toISOString()},i={sounds:[...t.sounds,a],lastModified:new Date().toISOString()};await this.savedSoundsAdapter.set("user-sounds",i)}catch(e){throw e}}async removeSavedSound(e){try{let t={sounds:(await this.loadSavedSounds()).sounds.filter(t=>t.id!==e),lastModified:new Date().toISOString()};await this.savedSoundsAdapter.set("user-sounds",t)}catch(e){throw e}}async isSoundSaved(e){try{return(await this.loadSavedSounds()).sounds.some(t=>t.id===e)}catch(e){return!1}}async clearSavedSounds(){try{await this.savedSoundsAdapter.remove("user-sounds")}catch(e){throw e}}isOPFSSupported(){return r.isSupported()}isIndexedDBSupported(){return"indexedDB"in window}isFullySupported(){return this.isIndexedDBSupported()&&this.isOPFSSupported()}constructor(){this.config={projectsDb:"video-editor-projects",mediaDb:"video-editor-media",timelineDb:"video-editor-timelines",savedSoundsDb:"video-editor-saved-sounds",version:1},this.projectsAdapter=new i(this.config.projectsDb,"projects",this.config.version),this.savedSoundsAdapter=new i(this.config.savedSoundsDb,"saved-sounds",this.config.version)}}let o=new n},75141:(e,t,a)=>{a.d(t,{U:()=>o});var i=a(59467);let r=[{name:"16:9",width:1920,height:1080},{name:"9:16",width:1080,height:1920},{name:"1:1",width:1080,height:1080},{name:"4:3",width:1440,height:1080}],n=e=>{let t=r[0],a=Math.abs(e-t.width/t.height);for(let i of r){let r=Math.abs(e-i.width/i.height);r<a&&(a=r,t=i)}return Math.abs(e-t.width/t.height)>.1?e>1?{width:1920,height:Math.round(1920/e)}:{width:Math.round(1080*e),height:1080}:{width:t.width,height:t.height}},o=(0,i.v)((e,t)=>({isInitializing:!0,isPanelsReady:!1,canvasSize:{width:1920,height:1080},canvasMode:"preset",canvasPresets:r,setInitializing:t=>{e({isInitializing:t})},setPanelsReady:t=>{e({isPanelsReady:t})},initializeApp:async()=>{e({isInitializing:!0,isPanelsReady:!1}),e({isPanelsReady:!0,isInitializing:!1})},setCanvasSize:t=>{e({canvasSize:t,canvasMode:"preset"})},setCanvasSizeToOriginal:t=>{e({canvasSize:n(t),canvasMode:"original"})},setCanvasSizeFromAspectRatio:t=>{e({canvasSize:n(t),canvasMode:"custom"})}}))},80196:(e,t,a)=>{a.d(t,{B:()=>u,C:()=>m,generateVideoThumbnail:()=>l,getFileType:()=>d,getImageDimensions:()=>s,getMediaDuration:()=>c});var i=a(59467),r=a(19439),n=a(8300),o=a(93146);let d=e=>{let{type:t}=e;return t.startsWith("image/")?"image":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":null},s=e=>new Promise((t,a)=>{let i=new window.Image;i.addEventListener("load",()=>{t({width:i.naturalWidth,height:i.naturalHeight}),i.remove()}),i.addEventListener("error",()=>{a(Error("Could not load image")),i.remove()}),i.src=URL.createObjectURL(e)}),l=e=>new Promise((t,a)=>{let i=document.createElement("video"),r=document.createElement("canvas"),n=r.getContext("2d");if(!n)return void a(Error("Could not get canvas context"));i.addEventListener("loadedmetadata",()=>{r.width=i.videoWidth,r.height=i.videoHeight,i.currentTime=Math.min(1,.1*i.duration)}),i.addEventListener("seeked",()=>{n.drawImage(i,0,0,r.width,r.height);let e=r.toDataURL("image/jpeg",.8);t({thumbnailUrl:e,width:i.videoWidth,height:i.videoHeight}),i.remove(),r.remove()}),i.addEventListener("error",()=>{a(Error("Could not load video")),i.remove(),r.remove()}),i.src=URL.createObjectURL(e),i.load()}),c=e=>new Promise((t,a)=>{let i=document.createElement(e.type.startsWith("video/")?"video":"audio");i.addEventListener("loadedmetadata",()=>{t(i.duration),i.remove()}),i.addEventListener("error",()=>{a(Error("Could not load media")),i.remove()}),i.src=URL.createObjectURL(e),i.load()}),m=e=>e.width&&e.height?e.width/e.height:16/9,u=(0,i.v)((e,t)=>({mediaItems:[],isLoading:!1,addMediaItem:async(t,a)=>{let i={...a,id:(0,o.lk)()};e(e=>({mediaItems:[...e.mediaItems,i]}));try{await r.P.saveMediaItem(t,i)}catch(t){e(e=>({mediaItems:e.mediaItems.filter(e=>e.id!==i.id)}))}},removeMediaItem:async(a,i)=>{let o=t().mediaItems.find(e=>e.id===i);(null==o?void 0:o.url)&&(URL.revokeObjectURL(o.url),o.thumbnailUrl&&URL.revokeObjectURL(o.thumbnailUrl)),e(e=>({mediaItems:e.mediaItems.filter(e=>e.id!==i)}));let{tracks:d,removeElementFromTrack:s,removeElementFromTrackWithRipple:l,rippleEditingEnabled:c,pushHistory:m}=n.A.getState(),u=[];for(let e of d)for(let t of e.elements)"media"===t.type&&t.mediaId===i&&u.push({trackId:e.id,elementId:t.id});if(u.length>0)for(let{trackId:e,elementId:t}of(m(),u))c?l(e,t,!1):s(e,t,!1);try{await r.P.deleteMediaItem(a,i)}catch(e){}},loadProjectMedia:async t=>{e({isLoading:!0});try{let a=await r.P.loadAllMediaItems(t),i=await Promise.all(a.map(async e=>{if("video"===e.type&&e.file)try{let{thumbnailUrl:t,width:a,height:i}=await l(e.file);return{...e,thumbnailUrl:t,width:a||e.width,height:i||e.height}}catch(e){}return e}));e({mediaItems:i})}catch(e){}finally{e({isLoading:!1})}},clearProjectMedia:async a=>{let i=t();i.mediaItems.forEach(e=>{e.url&&URL.revokeObjectURL(e.url),e.thumbnailUrl&&URL.revokeObjectURL(e.thumbnailUrl)}),e({mediaItems:[]});try{let e=i.mediaItems.map(e=>e.id);await Promise.all(e.map(e=>r.P.deleteMediaItem(a,e)))}catch(e){}},clearAllMedia:()=>{t().mediaItems.forEach(e=>{e.url&&URL.revokeObjectURL(e.url),e.thumbnailUrl&&URL.revokeObjectURL(e.thumbnailUrl)}),e({mediaItems:[]})}}))},82337:(e,t,a)=>{a.d(t,{I:()=>l});var i=a(59467),r=a(19439),n=a(61557),o=a(80196),d=a(8300),s=a(93146);let l=(0,i.v)((e,t)=>({activeProject:null,savedProjects:[],isLoading:!0,isInitialized:!1,invalidProjectIds:new Set,toggleBookmark:async a=>{let i,{activeProject:o}=t();if(!o)return;let d=o.fps||30,s=Math.round(a*d)/d,l=o.bookmarks||[],c=l.findIndex(e=>.001>Math.abs(e-s));i=-1!==c?l.filter((e,t)=>t!==c):[...l,s].sort((e,t)=>e-t);let m={...o,bookmarks:i,updatedAt:new Date};try{await r.P.saveProject(m),e({activeProject:m}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update bookmarks",{description:"Please try again"})}},isBookmarked:e=>{let{activeProject:a}=t();if(!a||!a.bookmarks)return!1;let i=a.fps||30,r=Math.round(e*i)/i;return a.bookmarks.some(e=>.001>Math.abs(e-r))},removeBookmark:async a=>{let{activeProject:i}=t();if(!i||!i.bookmarks)return;let o=i.fps||30,d=Math.round(a*o)/o,s=i.bookmarks.filter(e=>Math.abs(e-d)>=.001);if(s.length===i.bookmarks.length)return;let l={...i,bookmarks:s,updatedAt:new Date};try{await r.P.saveProject(l),e({activeProject:l}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to remove bookmark",{description:"Please try again"})}},createNewProject:async a=>{let i={id:(0,s.lk)(),name:a,thumbnail:"",createdAt:new Date,updatedAt:new Date,backgroundColor:"#000000",backgroundType:"color",blurIntensity:8,bookmarks:[],fps:30};e({activeProject:i});try{return await r.P.saveProject(i),await t().loadAllProjects(),i.id}catch(e){throw n.oR.error("Failed to save new project"),e}},loadProject:async a=>{t().isInitialized||e({isLoading:!0});let i=o.B.getState(),n=d.A.getState();i.clearAllMedia(),n.clearTimeline();try{let t=await r.P.loadProject(a);if(t)e({activeProject:t}),await Promise.all([i.loadProjectMedia(a),n.loadProjectTimeline(a)]);else throw Error("Project with id ".concat(a," not found"))}catch(e){throw e}finally{e({isLoading:!1})}},saveCurrentProject:async()=>{let{activeProject:e}=t();if(e)try{let a=d.A.getState();await Promise.all([r.P.saveProject(e),a.saveProjectTimeline(e.id)]),await t().loadAllProjects()}catch(e){}},loadAllProjects:async()=>{t().isInitialized||e({isLoading:!0});try{let t=await r.P.loadAllProjects();e({savedProjects:t})}catch(e){}finally{e({isLoading:!1,isInitialized:!0})}},deleteProject:async a=>{try{await Promise.all([r.P.deleteProjectMedia(a),r.P.deleteProjectTimeline(a),r.P.deleteProject(a)]),await t().loadAllProjects();let{activeProject:i}=t();if((null==i?void 0:i.id)===a){e({activeProject:null});let t=o.B.getState(),a=d.A.getState();t.clearAllMedia(),a.clearTimeline()}}catch(e){}},closeProject:()=>{e({activeProject:null});let t=o.B.getState(),a=d.A.getState();t.clearAllMedia(),a.clearTimeline()},renameProject:async(a,i)=>{let{savedProjects:o}=t(),d=o.find(e=>e.id===a);if(!d)return void n.oR.error("Project not found",{description:"Please try again"});let s={...d,name:i,updatedAt:new Date};try{await r.P.saveProject(s),await t().loadAllProjects();let{activeProject:i}=t();(null==i?void 0:i.id)===a&&e({activeProject:s})}catch(e){n.oR.error("Failed to rename project",{description:e instanceof Error?e.message:"Please try again"})}},duplicateProject:async e=>{try{let a=await r.P.loadProject(e);if(!a)throw n.oR.error("Project not found",{description:"Please try again"}),Error("Project not found");let{savedProjects:i}=t(),o=a.name.match(/^\((\d+)\)\s+(.+)$/),d=o?o[2]:a.name,l=[];i.forEach(e=>{let t=e.name.match(/^\((\d+)\)\s+(.+)$/);t&&t[2]===d&&l.push(parseInt(t[1],10))});let c=l.length>0?Math.max(...l)+1:1,m={...a,id:(0,s.lk)(),name:"(".concat(c,") ").concat(d),createdAt:new Date,updatedAt:new Date};return await r.P.saveProject(m),await t().loadAllProjects(),m.id}catch(e){throw n.oR.error("Failed to duplicate project",{description:e instanceof Error?e.message:"Please try again"}),e}},updateProjectBackground:async a=>{let{activeProject:i}=t();if(!i)return;let o={...i,backgroundColor:a,updatedAt:new Date};try{await r.P.saveProject(o),e({activeProject:o}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update background",{description:"Please try again"})}},updateBackgroundType:async(a,i)=>{let{activeProject:o}=t();if(!o)return;let d={...o,backgroundType:a,...(null==i?void 0:i.backgroundColor)&&{backgroundColor:i.backgroundColor},...(null==i?void 0:i.blurIntensity)&&{blurIntensity:i.blurIntensity},updatedAt:new Date};try{await r.P.saveProject(d),e({activeProject:d}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update background",{description:"Please try again"})}},updateProjectFps:async a=>{let{activeProject:i}=t();if(!i)return;let o={...i,fps:a,updatedAt:new Date};try{await r.P.saveProject(o),e({activeProject:o}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update project FPS",{description:"Please try again"})}},getFilteredAndSortedProjects:(e,a)=>{let{savedProjects:i}=t();return[...i.filter(t=>t.name.toLowerCase().includes(e.toLowerCase()))].sort((e,t)=>{let[i,r]=a.split("-");if("createdAt"!==i&&"name"!==i)return 0;let n=e[i],o=t[i];return void 0===n||void 0===o?0:"asc"===r?n<o?-1:+(n>o):n>o?-1:+(n<o)})},isInvalidProjectId:e=>(t().invalidProjectIds||new Set).has(e),markProjectIdAsInvalid:t=>{e(e=>({invalidProjectIds:new Set([...e.invalidProjectIds||new Set,t])}))},clearInvalidProjectIds:()=>{e({invalidProjectIds:new Set})}}))},87100:(e,t,a)=>{a.d(t,{A0:()=>r,Ij:()=>s,Tm:()=>c,gY:()=>m,of:()=>l,sn:()=>d,t_:()=>o});let i={media:{solid:"bg-blue-500",background:"",border:""},text:{solid:"bg-[#5DBAA0]",background:"bg-[#5DBAA0]",border:""},audio:{solid:"bg-green-500",background:"bg-[#915DBE]",border:""}};function r(e){let t=i[e];return"".concat(t.background," ").concat(t.border)}let n={media:60,text:25,audio:50};function o(e){return n[e]}function d(e,t){return e.slice(0,t).reduce((e,t)=>e+n[t.type]+4,0)}function s(e){return e.reduce((e,t)=>e+n[t.type],0)+4*Math.max(0,e.length-1)}let l={ELEMENT_MIN_WIDTH:80,PIXELS_PER_SECOND:50,TRACK_HEIGHT:60,DEFAULT_TEXT_DURATION:5,DEFAULT_IMAGE_DURATION:5,ZOOM_LEVELS:[.25,.5,1,1.5,2,3,4]},c=[{value:"24",label:"24 fps"},{value:"25",label:"25 fps"},{value:"30",label:"30 fps"},{value:"60",label:"60 fps"},{value:"120",label:"120 fps"}];function m(e,t){return t<=0?e:Math.round(e*t)/t}},93146:(e,t,a)=>{a.d(t,{C7:()=>c,Fe:()=>d,bT:()=>m,cn:()=>n,lg:()=>l,lk:()=>o,mr:()=>s});var i=a(54083),r=a(14234);function n(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,r.QP)((0,i.$)(t))}function o(){if("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID)return crypto.randomUUID();let e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let t=[...e].map(e=>e.toString(16).padStart(2,"0"));return t.slice(0,4).join("")+"-"+t.slice(4,6).join("")+"-"+t.slice(6,8).join("")+"-"+t.slice(8,10).join("")+"-"+t.slice(10,16).join("")}function d(e){return!!e&&(e instanceof Element||e instanceof HTMLElement)}function s(e){return!!e.isContentEditable||("INPUT"===e.tagName||"TEXTAREA"===e.tagName)&&!e.disabled}function l(){return/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)}function c(){return l()?"⌘":"Ctrl"}function m(){return l()?"⌥":"Alt"}}}]);
//# sourceMappingURL=83-4398df1e2258347e.js.map